<!DOCTYPE html>
<html lang="de" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Familien-Organisator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Using the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Simple transition for showing/hiding content */
        .page, #completed-task-list-container {
            transition: all 0.5s ease-in-out;
        }
        #completed-chevron.rotate-180 {
            transform: rotate(180deg);
        }
        /* Ensure date input text is visible in dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
           filter: invert(1);
        }
        /* Style for active nav button */
        .nav-btn-active {
            background-color: #3b82f6 !important;
            color: white !important;
        }
        .pin-btn-pinned svg {
            fill: #f59e0b; /* amber-500 */
            stroke: #f59e0b;
        }
        /* Weather Canvas Styling */
        #weatherCanvas {
            width: 100%;
            height: 120px;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-300">

    <!-- User Selection Header -->
    <div id="user-selection-header" class="p-4 bg-white dark:bg-slate-800 shadow-md sticky top-0 z-20">
        <div class="container mx-auto max-w-4xl flex items-center justify-end gap-4">
            <!-- Dark Mode Toggle -->
            <button id="darkModeToggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-400"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden text-slate-600 dark:text-slate-400"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
             <!-- Settings Button -->
            <button id="openSettingsBtn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-400"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
            <label for="userSelection" class="font-semibold text-slate-700 dark:text-slate-300">Angemeldet als:</label>
            <select id="userSelection" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition bg-white w-48 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200">
                <option value="null">Profil auswählen...</option>
            </select>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav id="main-nav" class="bg-white/70 dark:bg-slate-800/70 backdrop-blur-lg p-2 sticky top-[80px] z-20 mb-4 shadow-sm">
        <div class="container mx-auto max-w-4xl flex items-center justify-center gap-4">
            <button data-page="dashboard-page" class="nav-btn font-semibold text-slate-600 dark:text-slate-300 px-4 py-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition">Dashboard</button>
            <button data-page="notes-page" class="nav-btn font-semibold text-slate-600 dark:text-slate-300 px-4 py-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition">Notizen</button>
        </div>
    </nav>
    
    <!-- Welcome / Setup Message -->
    <div id="setup-message" class="container mx-auto p-4 md:p-8 max-w-4xl text-center" style="display: none;">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-4">Willkommen beim Familien-Organisator!</h2>
            <p class="text-slate-600 dark:text-slate-400 mb-6">Es sind noch keine Mitglieder angelegt. Bitte fügen Sie das erste Mitglied in den Einstellungen hinzu, um zu beginnen.</p>
            <button id="setupGoToSettingsBtn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow-sm">
                Einstellungen öffnen
            </button>
        </div>
    </div>


    <!-- =========== DASHBOARD PAGE =========== -->
    <div id="dashboard-page" class="page container mx-auto p-4 md:p-8 max-w-4xl" style="display: none;">

        <!-- Header -->
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100">Familien-Organisator</h1>
            <p class="text-slate-600 dark:text-slate-400 mt-2">Ein zentraler Ort für Mitglieder, Aufgaben und mehr.</p>
        </header>

        <main>
             <!-- Info Widgets Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <section class="flex flex-col">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-slate-100">Wetter & Zeit</h2>
                    <div id="weather-widget" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md flex flex-col justify-between flex-grow">
                        <div id="weather-content" class="relative text-center flex-grow flex flex-col justify-center min-h-[120px]">
                            <canvas id="weatherCanvas"></canvas>
                            <div id="weather-text-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black/10 dark:bg-black/20 p-2 rounded-lg">
                                <p id="weatherLocation" class="text-lg font-semibold text-white "></p>
                                <p id="weatherTemp" class="text-4xl font-bold text-white"></p>
                                <p id="weatherDesc" class="text-white"></p>
                            </div>
                        </div>
                        <div id="time-content" class="text-center mt-4">
                             <p id="currentTime" class="text-3xl font-bold text-slate-800 dark:text-slate-200 tracking-tight">--:--:--</p>
                        </div>
                        <div id="clothing-recommendation" class="mt-4 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg text-center">
                            <p class="text-slate-500 dark:text-slate-400 text-sm">Lade Kleidungstipp...</p>
                        </div>
                    </div>
                </section>
                <section class="flex flex-col">
                    <div class="flex justify-between items-baseline mb-4">
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Heutige Aufgaben</h2>
                        <p id="calendarWeek" class="text-lg font-bold text-blue-600 dark:text-blue-500">KW --</p>
                    </div>
                    <div id="todays-tasks-widget" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md flex flex-col flex-grow">
                        <div id="todays-tasks-list" class="space-y-2 overflow-y-auto pr-2"></div>
                    </div>
                </section>
            </div>
            
            <!-- Pinned Notes & Notifications Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <section id="pinned-notes-widget" class="lg:col-span-2">
                     <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-slate-100">Gepinnte Notizen</h2>
                     <div id="pinned-notes-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                         <!-- Pinned notes will be inserted here -->
                     </div>
                </section>
                <section id="notifications-widget">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-slate-100">Benachrichtigungen</h2>
                    <div id="notifications-list" class="space-y-3">
                        <!-- Notifications will be inserted here -->
                    </div>
                </section>
            </div>

            <!-- Add New Task Section -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-slate-100">Neue Aufgabe hinzufügen</h2>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <div class="space-y-4">
                        <input type="text" id="newTaskInput" placeholder="Was muss erledigt werden?" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-slate-700 dark:border-slate-600 dark:placeholder-slate-400">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                            <select id="newTaskPriority" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition bg-white dark:bg-slate-700 dark:border-slate-600">
                                <option value="low">Niedrig</option>
                                <option value="medium" selected>Mittel</option>
                                <option value="high">Hoch</option>
                            </select>
                            <select id="newTaskRecurrence" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition bg-white dark:bg-slate-700 dark:border-slate-600">
                                <option value="none">Einmalig</option>
                                <option value="daily">Täglich</option>
                                <option value="weekly">Wöchentlich</option>
                                <option value="monthly">Monatlich</option>
                                <option value="yearly">Jährlich</option>
                            </select>
                            <select id="newTaskAssignee" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition bg-white dark:bg-slate-700 dark:border-slate-600"></select>
                            <input type="date" id="newTaskDueDate" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-slate-700 dark:border-slate-600">
                        </div>
                    </div>
                    <div class="mt-4">
                        <button id="addTaskBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow-sm dark:bg-blue-700 dark:hover:bg-blue-600">Hinzufügen</button>
                    </div>
                </div>
            </section>
        
            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-slate-100">Aufgabenliste</h2>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <div id="task-list" class="space-y-3"></div>
                </div>
            </section>
            <section>
                 <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-slate-100">Erledigte Aufgaben</h2>
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md">
                     <button id="toggleCompletedTasks" class="w-full flex justify-between items-center text-left p-4 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition focus:outline-none rounded-t-xl border-b border-slate-200 dark:border-slate-700">
                        <span class="font-bold text-slate-700 dark:text-slate-200">Liste anzeigen/verbergen</span>
                        <svg id="completed-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform transform"><polyline points="6 9 12 15 18 9"></polyline></svg>
                     </button>
                     <div id="completed-task-list-container" class="p-6 hidden">
                         <div id="completed-task-list" class="space-y-3"></div>
                     </div>
                </div>
            </section>
        </main>
    </div>

    <!-- =========== NOTES PAGE =========== -->
    <div id="notes-page" class="page container mx-auto p-4 md:p-8 max-w-4xl" style="display: none;">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4 dark:text-slate-100">Neue Notiz erstellen</h2>
            <div class="space-y-4">
                <input type="text" id="newNoteTitle" placeholder="Titel" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-slate-700 dark:border-slate-600 dark:placeholder-slate-400">
                <textarea id="newNoteContent" placeholder="Inhalt...&#10;Für eine Einkaufsliste, schreibe jeden Eintrag in eine neue Zeile." rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-slate-700 dark:border-slate-600 dark:placeholder-slate-400"></textarea>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <select id="newNoteAssignee" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition bg-white dark:bg-slate-700 dark:border-slate-600"></select>
                    <select id="newNoteType" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition bg-white dark:bg-slate-700 dark:border-slate-600">
                        <option value="text">Textnotiz</option>
                        <option value="checklist">Einkaufsliste</option>
                    </select>
                    <button id="addNoteBtn" class="sm:col-start-3 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow-sm dark:bg-blue-700 dark:hover:bg-blue-600">Notiz erstellen</button>
                </div>
            </div>
        </div>
        <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Notes will be inserted here -->
        </div>
    </div>


    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 md:p-8 w-11/12 max-w-2xl relative max-h-[90vh] flex flex-col">
            <div class="flex-shrink-0">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold dark:text-slate-100">Einstellungen</h2>
                    <button id="closeSettingsBtn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-400"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto pr-2">
                <div class="mb-8">
                    <h3 class="text-xl font-semibold border-b dark:border-slate-600 pb-2 mb-4 dark:text-slate-200">Mitglieder verwalten</h3>
                    <div id="settings-member-list" class="space-y-4"></div>
                     <button id="addMemberBtn" class="mt-4 w-full bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-300 transition dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600">
                        + Mitglied hinzufügen
                    </button>
                </div>
                <div>
                    <h3 class="text-xl font-semibold border-b dark:border-slate-600 pb-2 mb-4 dark:text-slate-200">Kalender</h3>
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                        <p class="text-slate-700 dark:text-slate-300">Externen Zugriff erlauben</p>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" value="" class="sr-only peer">
                          <div class="w-11 h-6 bg-gray-200 dark:bg-slate-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                     <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg mt-4">
                        <p class="text-slate-700 dark:text-slate-300">Kalender-Link teilen</p>
                        <button class="px-4 py-2 text-sm font-semibold text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200 transition dark:bg-blue-200 dark:text-blue-800 dark:hover:bg-blue-300">Link kopieren</button>
                    </div>
                </div>
            </div>
            <div class="flex-shrink-0 mt-8 pt-4 border-t dark:border-slate-600 flex justify-end">
                <button id="saveAllSettingsBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition shadow-sm dark:bg-blue-700 dark:hover:bg-blue-600">
                    Änderungen speichern
                </button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp as initializeFirebaseApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATA ---
        let familyMembers = [];
        let tasks = [];
        let notes = [];
        let notifications = [];

        let currentUser = null; // This will store the Firestore ID of the logged-in member

        // Firebase instances
        let db, auth;

        // --- DOM ELEMENTS ---
        const userSelection = document.getElementById('userSelection');
        const userSelectionLabel = document.querySelector('label[for="userSelection"]');
        const taskListContainer = document.getElementById('task-list');
        const completedTaskListContainer = document.getElementById('completed-task-list');
        const completedTaskListWrapper = document.getElementById('completed-task-list-container');
        const toggleCompletedTasksBtn = document.getElementById('toggleCompletedTasks');
        const completedChevron = document.getElementById('completed-chevron');
        const newTaskInput = document.getElementById('newTaskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const newTaskPriority = document.getElementById('newTaskPriority');
        const newTaskRecurrence = document.getElementById('newTaskRecurrence');
        const newTaskAssignee = document.getElementById('newTaskAssignee');
        const newTaskDueDate = document.getElementById('newTaskDueDate');
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsMemberListContainer = document.getElementById('settings-member-list');
        const saveAllSettingsBtn = document.getElementById('saveAllSettingsBtn');
        const addMemberBtn = document.getElementById('addMemberBtn');
        const currentTimeEl = document.getElementById('currentTime');
        const calendarWeekEl = document.getElementById('calendarWeek');
        const clothingRecommendationEl = document.getElementById('clothing-recommendation');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const htmlEl = document.documentElement;
        const nav = document.getElementById('main-nav');
        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page');
        const setupMessage = document.getElementById('setup-message');
        const setupGoToSettingsBtn = document.getElementById('setupGoToSettingsBtn');
        const notesGrid = document.getElementById('notes-grid');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const newNoteTitle = document.getElementById('newNoteTitle');
        const newNoteContent = document.getElementById('newNoteContent');
        const newNoteAssignee = document.getElementById('newNoteAssignee');
        const newNoteType = document.getElementById('newNoteType');
        const pinnedNotesGrid = document.getElementById('pinned-notes-grid');
        const notificationsList = document.getElementById('notifications-list');

        // Weather Animation Elements
        const weatherCanvas = document.getElementById('weatherCanvas');
        const weatherLocationEl = document.getElementById('weatherLocation');
        const weatherTempEl = document.getElementById('weatherTemp');
        const weatherDescEl = document.getElementById('weatherDesc');
        let animationFrameId; // To control the animation loop


        // --- HELPER FUNCTIONS ---
        function getPriorityIndicator(priority) {
            switch (priority) {
                case 'high': return `<span class="h-3 w-3 bg-red-500 rounded-full" title="Hohe Priorität"></span>`;
                case 'medium': return `<span class="h-3 w-3 bg-orange-500 rounded-full" title="Mittlere Priorität"></span>`;
                case 'low': return `<span class="h-3 w-3 bg-green-500 rounded-full" title="Niedrige Priorität"></span>`;
                default: return `<span class="h-3 w-3 bg-slate-300 rounded-full" title="Keine Priorität"></span>`;
            }
        }

        function getRecurringIcon(recurrence) {
            const recurrenceMap = { daily: 'Täglich', weekly: 'Wöchentlich', monthly: 'Monatlich', yearly: 'Jährlich' };
            const title = `${recurrenceMap[recurrence] || ''} wiederkehrende Aufgabe`;
            return `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500 dark:text-slate-400" title="${title}"><path d="M17 2.1l4 4-4 4"/><path d="M3 12.6A9 9 0 0 1 15 5.1l6 0"/><path d="M7 21.9l-4-4 4-4"/><path d="M21 11.4A9 9 0 0 1 9 18.9l-6 0"/></svg>`;
        }
        
        function getAssigneeDisplay(memberId) {
            if (!memberId) return '';
            const member = familyMembers.find(m => m.id === memberId);
            if (!member) return '';
            const isCurrentUser = member.id === currentUser;
            const styleClasses = isCurrentUser 
                ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/70 dark:text-blue-200' 
                : 'bg-slate-200 text-slate-700 dark:bg-slate-600 dark:text-slate-200';
            
            return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${styleClasses}">${member.name}</span>`;
        }
        
        function formatCompletionDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function formatDueDate(dateString) {
            if (!dateString) return '';
            const dateParts = dateString.split('-').map(part => parseInt(part, 10));
            const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let colorClass = 'text-slate-500 dark:text-slate-400';
            if (date < today) {
                colorClass = 'text-red-500 dark:text-red-400 font-semibold'; // Overdue
            } else if (date.getTime() === today.getTime()) {
                colorClass = 'text-orange-500 dark:text-orange-400 font-semibold'; // Today
            }
            const formattedDate = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            return `<span class="font-medium ${colorClass} flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>${formattedDate}</span>`;
        }


        // --- RENDER FUNCTIONS ---
        function renderAllContent() {
            renderAllTasks();
            renderNotes();
            renderPinnedNotesOnDashboard();
            renderNotifications();
        }
        
        function renderAllTasks() {
            const activeTasks = tasks.filter(task => !task.isDone);
            const completedTasks = tasks.filter(task => task.isDone);
            renderActiveTasks(activeTasks);
            renderCompletedTasks(completedTasks);
            renderTodaysTasks();
            addTaskActionListeners();
        }
        
        function renderActiveTasks(activeTasks) {
            if(!taskListContainer) return;
            taskListContainer.innerHTML = '';
            const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
            activeTasks.sort((a, b) => {
                if (a.dueDate && !b.dueDate) return -1;
                if (!a.dueDate && b.dueDate) return 1;
                if (a.dueDate && b.dueDate) {
                    if (new Date(a.dueDate) < new Date(b.dueDate)) return -1;
                    if (new Date(a.dueDate) > new Date(b.dueDate)) return 1;
                }
                return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
            });
            if (activeTasks.length === 0) {
                taskListContainer.innerHTML = `<p class="text-slate-500 dark:text-slate-400 text-center p-4">Keine offenen Aufgaben. Sehr gut!</p>`;
            } else {
                activeTasks.forEach(task => {
                    const isUsersTask = task.assignedTo === currentUser;
                    const highlightClass = isUsersTask ? 'bg-blue-50 dark:bg-blue-900/50' : 'hover:bg-slate-50 dark:hover:bg-slate-700/50';
                    const taskItem = `<div class="flex items-center p-3 rounded-lg group ${highlightClass} transition"><div class="flex-grow flex items-center"><input type="checkbox" id="task-${task.id}" data-task-id="${task.id}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer dark:bg-slate-600 dark:border-slate-500 flex-shrink-0"><div class="ml-3"><label for="task-${task.id}" class="text-slate-700 dark:text-slate-300 cursor-pointer">${task.title}</label><div class="flex items-center gap-3 mt-1 text-xs">${getPriorityIndicator(task.priority)}${task.recurrence !== 'none' ? getRecurringIcon(task.recurrence) : ''}${task.dueDate ? formatDueDate(task.dueDate) : ''}</div></div></div><div class="ml-auto pl-2 flex items-center gap-2 flex-shrink-0">${getAssigneeDisplay(task.assignedTo)}<button data-task-id="${task.id}" data-task-title="${task.title}" class="breakdown-btn px-2 py-1 text-xs font-semibold text-blue-600 bg-blue-100 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-50 disabled:cursor-wait flex items-center justify-center dark:bg-blue-200 dark:text-blue-800" style="min-width: 80px; height: 28px;">✨ Aufteilen</button></div></div>`;
                    taskListContainer.innerHTML += taskItem;
                });
            }
        }
        
        function renderCompletedTasks(completedTasks) {
            if(!completedTaskListContainer) return;
            completedTaskListContainer.innerHTML = '';
            completedTasks.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
            if (completedTasks.length === 0) {
                completedTaskListContainer.innerHTML = `<p class="text-slate-500 dark:text-slate-400 text-center p-4">Noch keine Aufgaben erledigt.</p>`;
            } else {
                completedTasks.forEach(task => {
                    const taskItem = `<div class="flex items-center p-3 rounded-lg group bg-slate-50 dark:bg-slate-700/50"><input type="checkbox" id="task-${task.id}" data-task-id="${task.id}" checked class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer dark:bg-slate-600 dark:border-slate-500"><label for="task-${task.id}" class="ml-3 flex-grow text-slate-500 dark:text-slate-400 line-through cursor-pointer">${task.title}</label><div class="ml-auto pl-2 flex items-center gap-3"><span class="text-sm text-slate-400 dark:text-slate-500 font-medium">Erledigt: ${formatCompletionDate(task.completedAt)}</span>${getAssigneeDisplay(task.assignedTo)}</div></div>`;
                    completedTaskListContainer.innerHTML += taskItem;
                });
            }
        }
        
        function renderTodaysTasks() {
            const todaysTasksList = document.getElementById('todays-tasks-list');
            if (!todaysTasksList || currentUser === null) return;
            const todaysUserTasks = tasks.filter(task => !task.isDone && task.assignedTo === currentUser);
            if (todaysUserTasks.length === 0) {
                todaysTasksList.innerHTML = `<p class="text-slate-500 dark:text-slate-400 text-center py-4">Keine Aufgaben für heute!</p>`;
                return;
            }
            todaysTasksList.innerHTML = '';
            todaysUserTasks.forEach(task => {
                const taskItem = `<div class="flex items-center bg-slate-50 dark:bg-slate-700/50 p-2 rounded-lg"><div class="flex-shrink-0">${getPriorityIndicator(task.priority)}</div><span class="ml-2 text-sm text-slate-700 dark:text-slate-300">${task.title}</span></div>`;
                todaysTasksList.innerHTML += taskItem;
            });
        }
        
        function renderNotes() {
            if(!notesGrid) return;
            notesGrid.innerHTML = '';
            
            // Pinned notes first
            notes.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));

            notes.forEach(note => {
                let contentHtml = '';
                if (note.type === 'checklist') {
                    // Ensure content is an array before trying to map
                    const items = Array.isArray(note.content) ? note.content : [];
                    contentHtml = '<ul class="space-y-2">';
                    items.forEach((item, index) => {
                        contentHtml += `<li class="flex items-center"><input type="checkbox" id="note-${note.id}-item-${index}" data-note-id="${note.id}" data-item-index="${index}" ${item.done ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer dark:bg-slate-600 dark:border-slate-500"><label for="note-${note.id}-item-${index}" class="ml-2 ${item.done ? 'line-through text-slate-500 dark:text-slate-400' : 'text-slate-700 dark:text-slate-300'} cursor-pointer">${item.text}</label></li>`;
                    });
                    contentHtml += '</ul>';
                } else {
                    contentHtml = `<p class="text-slate-700 dark:text-slate-300 whitespace-pre-wrap">${note.content}</p>`;
                }

                const pinClass = note.isPinned ? 'pin-btn-pinned' : '';
                const recipeButtonHtml = note.type === 'checklist' 
                    ? `<button data-note-id="${note.id}" class="recipe-btn px-2 py-1 text-xs font-semibold text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200 dark:bg-blue-200 dark:text-blue-800 dark:hover:bg-blue-300 transition flex items-center justify-center" style="height: 28px;">✨ Rezept</button>` 
                    : '<div></div>';

                const noteCard = `
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-4 flex flex-col gap-3 relative">
                         <button data-note-id="${note.id}" class="pin-note-btn absolute top-2 right-2 p-2 text-slate-400 hover:text-amber-500 rounded-full transition ${pinClass}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17v5"></path><path d="M15 17H9"></path><path d="M12 12a1 1 0 0 0-1 1v4h2v-4a1 1 0 0 0-1-1Z"></path><path d="M18 8.8c0 2.3-1.4 4.2-3 5.2"></path><path d="M6 8.8c0 2.3 1.4 4.2 3 5.2"></path><path d="M12 2a4 4 0 0 0-4 4c0 3 4 8 4 8s4-5 4-8a4 4 0 0 0-4-4Z"></path></svg>
                        </button>
                        <h3 class="font-bold text-lg text-slate-900 dark:text-slate-100 pr-8">${note.title}</h3>
                        <div class="flex-grow">${contentHtml}</div>
                        <div class="mt-2 pt-2 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center">
                            ${recipeButtonHtml}
                            ${getAssigneeDisplay(note.assignedTo)}
                        </div>
                    </div>`;
                notesGrid.innerHTML += noteCard;
            });
            addNoteActionListeners();
        }

        function renderPinnedNotesOnDashboard() {
            if (!pinnedNotesGrid) return;
            const pinned = notes.filter(n => n.isPinned);

            if (pinned.length === 0) {
                pinnedNotesGrid.innerHTML = `<p class="text-slate-500 dark:text-slate-400 text-center p-4 col-span-full">Keine Notizen angepinnt.</p>`;
                return;
            }

            pinnedNotesGrid.innerHTML = '';
            pinned.forEach(note => {
                const noteCard = `
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md p-4 flex flex-col gap-2">
                        <h3 class="font-bold text-md text-slate-900 dark:text-slate-100 truncate">${note.title}</h3>
                        <div class="mt-auto pt-2 border-t border-slate-200 dark:border-slate-700 flex justify-end">
                            ${getAssigneeDisplay(note.assignedTo)}
                        </div>
                    </div>`;
                pinnedNotesGrid.innerHTML += noteCard;
            });
        }

        function renderNotifications() {
            if (!notificationsList || currentUser === null) return;

            const userNotifications = notifications.filter(n => n.recipientId === currentUser && !n.isRead);

            if (userNotifications.length === 0) {
                notificationsList.innerHTML = `<p class="text-slate-500 dark:text-slate-400 text-center p-4">Keine neuen Benachrichtigungen.</p>`;
                return;
            }

            notificationsList.innerHTML = '';
            userNotifications.forEach(n => {
                const notificationItem = `
                    <div class="bg-blue-50 dark:bg-blue-900/50 p-3 rounded-lg flex items-start gap-3 relative">
                        <div class="flex-shrink-0 text-blue-500 dark:text-blue-400 mt-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        </div>
                        <p class="text-sm text-slate-700 dark:text-slate-300 flex-grow">
                            <strong>${n.senderName}</strong> hat dir eine neue Aufgabe zugewiesen: "${n.taskTitle}"
                        </p>
                        <button data-notification-id="${n.id}" class="dismiss-notification-btn absolute top-1 right-1 p-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                `;
                notificationsList.innerHTML += notificationItem;
            });

            addNotificationActionListeners();
        }

        function renderSettings() {
            settingsMemberListContainer.innerHTML = '';
            familyMembers.forEach(member => {
                const memberSettingItem = `<div class="flex items-center gap-4 group"><input type="text" value="${member.name}" data-member-id="${member.id}" placeholder="Name" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-slate-700 dark:border-slate-600"><input type="text" value="${member.role}" data-member-id="${member.id}" placeholder="Rolle (z.B. Sohn)" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-slate-700 dark:border-slate-600"><button data-member-id="${member.id}" class="remove-member-btn p-2 text-slate-400 hover:text-red-500 hover:bg-red-100 rounded-full transition dark:hover:bg-red-900/50 dark:hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></div>`;
                settingsMemberListContainer.innerHTML += memberSettingItem;
            });
            document.querySelectorAll('.remove-member-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const memberIdToRemove = e.currentTarget.dataset.memberId;
                    e.currentTarget.closest('.group').remove(); // Visually remove immediately for better UX
                     // The actual deletion will happen on save
                });
            });
        }
        
        function populateAllAssigneeDropdowns() {
            const dropdowns = [newTaskAssignee, newNoteAssignee];
            dropdowns.forEach(dropdown => {
                if(dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="null">Niemandem zuweisen</option>';
                    familyMembers.forEach(member => {
                        dropdown.innerHTML += `<option value="${member.id}">${member.name}</option>`;
                    });
                    dropdown.value = currentValue;
                }
            });
        }

        function populateUserSelection() {
            const currentValue = userSelection.value;
            userSelection.innerHTML = '<option value="null">Profil auswählen...</option>';
            familyMembers.forEach(member => {
                userSelection.innerHTML += `<option value="${member.id}">${member.name}</option>`;
            });
            userSelection.value = currentValue;
        }

        // --- GEMINI API INTEGRATION ---
        async function callGeminiAPI(prompt) { 
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { console.error("API Error:", await response.text()); return null; }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) { console.error("Error calling API:", error); return null; }
        }
        async function callGeminiForTaskBreakdown(taskTitle) { 
            const prompt = `Teile die folgende Aufgabe in eine einfache, durch Kommas getrennte Liste kleinerer, umsetzbarer Teilaufgaben auf. Gib NUR die Liste zurück, sonst nichts. Aufgabe: "${taskTitle}"`;
            const resultText = await callGeminiAPI(prompt);
            return resultText ? resultText.split(',').map(s => s.trim()).filter(s => s) : null;
        }
        async function callGeminiForClothing(temp, description) {
            const prompt = `Gib eine kurze, freundliche Kleidungsempfehlung auf Deutsch für das folgende Wetter. Antworte in einem einzigen, kompletten Satz. Wetter: ${temp}°C und ${description}.`;
            return await callGeminiAPI(prompt);
        }
        async function callGeminiForRecipe(ingredients) {
            const prompt = `Erstelle ein einfaches Rezept mit den folgenden Zutaten: ${ingredients.join(', ')}. Antworte auf Deutsch. Deine Antwort MUSS mit dem Rezepttitel in der ersten Zeile beginnen. Danach folgen die Abschnitte "**Zutaten:**" und "**Zubereitung:**", jeweils in einer neuen Zeile und mit Markdown formatiert.`;
            return await callGeminiAPI(prompt);
        }
        
        // --- THEME & WIDGET FUNCTIONS ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                htmlEl.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
        }

        function updateTime() { currentTimeEl.textContent = new Date().toLocaleTimeString('de-DE'); }
        function getCalendarWeek() {
            const date = new Date(); date.setHours(0, 0, 0, 0); date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        // --- WEATHER ANIMATION ---
        let weatherState = { particles: [] };

        function setupWeatherAnimation(weatherData) {
            cancelAnimationFrame(animationFrameId); // Stop previous loop
            
            const desc = weatherData.description.toLowerCase();
            const hour = new Date().getHours();
            
            weatherState.isDay = hour > 6 && hour < 20;
            weatherState.particles = [];
            weatherState.windSpeed = desc.includes('wind') ? 0.8 : 0.3;

            // Clouds
            let cloudCount = 0;
            if (desc.includes('bewölkt') || desc.includes('wolkig')) cloudCount = 5;
            if (desc.includes('stark bewölkt')) cloudCount = 10;
            if (desc.includes('wenig wolken')) cloudCount = 3;
            if (desc.includes('klar') || desc.includes('sonnig')) cloudCount = 1;

            for (let i = 0; i < cloudCount; i++) {
                weatherState.particles.push({
                    type: 'cloud',
                    x: Math.random() * weatherCanvas.width,
                    y: Math.random() * (weatherCanvas.height * 0.5),
                    radius: Math.random() * 20 + 20,
                    speed: (Math.random() * 0.5 + 0.1) * weatherState.windSpeed
                });
            }

            // Rain
            let rainCount = 0;
            if (desc.includes('regen') || desc.includes('schauer')) rainCount = 100;
            if (desc.includes('stark')) rainCount = 300;
            if (desc.includes('leicht')) rainCount = 50;

            for (let i = 0; i < rainCount; i++) {
                weatherState.particles.push({
                    type: 'rain',
                    x: Math.random() * weatherCanvas.width,
                    y: Math.random() * weatherCanvas.height,
                    length: Math.random() * 15 + 5,
                    speed: Math.random() * 5 + 3
                });
            }

            // Stars
            if (!weatherState.isDay) {
                for (let i = 0; i < 50; i++) {
                    weatherState.particles.push({
                        type: 'star',
                        x: Math.random() * weatherCanvas.width,
                        y: Math.random() * weatherCanvas.height,
                        radius: Math.random() * 1.5
                    });
                }
            }

            animateWeather();
        }

        function animateWeather() {
            const ctx = weatherCanvas.getContext('2d');
            const { width, height } = weatherCanvas;
            
            // Background
            if (weatherState.isDay) {
                 ctx.fillStyle = '#87CEEB'; // Sky blue
            } else {
                 ctx.fillStyle = '#0f172a'; // Slate-900
            }
            ctx.fillRect(0, 0, width, height);

            // Sun / Moon
            if (weatherState.isDay) {
                ctx.fillStyle = 'rgba(255, 223, 0, 0.8)';
                ctx.beginPath();
                ctx.arc(width * 0.2, height * 0.25, 25, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.fillStyle = 'rgba(240, 240, 240, 0.9)';
                ctx.beginPath();
                ctx.arc(width * 0.2, height * 0.3, 20, 0, Math.PI * 2);
                ctx.fill();
            }

            // Particles
            weatherState.particles.forEach(p => {
                if (p.type === 'star') {
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                }

                if (p.type === 'cloud') {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.arc(p.x + p.radius * 0.8, p.y, p.radius * 0.8, 0, Math.PI * 2);
                    ctx.arc(p.x - p.radius * 0.8, p.y, p.radius * 0.7, 0, Math.PI * 2);
                    ctx.fill();
                    p.x += p.speed;
                    if (p.x > width + p.radius) p.x = -p.radius;
                }

                if (p.type === 'rain') {
                    ctx.strokeStyle = 'rgba(173, 216, 230, 0.6)';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x, p.y + p.length);
                    ctx.stroke();
                    p.y += p.speed;
                    if (p.y > height) {
                        p.y = -p.length;
                        p.x = Math.random() * width;
                    }
                }
            });

            animationFrameId = requestAnimationFrame(animateWeather);
        }


        async function displayWeather(data) {
            weatherLocationEl.textContent = data.location;
            weatherTempEl.textContent = `${data.temp}°C`;
            weatherDescEl.textContent = data.description;
            
            const rect = weatherCanvas.getBoundingClientRect();
            weatherCanvas.width = rect.width;
            weatherCanvas.height = rect.height;

            setupWeatherAnimation(data);
             
            const recommendation = await callGeminiForClothing(data.temp, data.description);
            clothingRecommendationEl.innerHTML = recommendation ? `<p class="text-slate-800 dark:text-slate-200 text-sm font-semibold">✨ ${recommendation}</p>` : `<p class="text-slate-500 dark:text-slate-400 text-sm">Kleidungstipp konnte nicht geladen werden.</p>`;
        }
        async function fetchWeather(lat, lon) { 
            const weathers = [
                { location: "Leutkirch", temp: 18, description: "Sonnig mit wenig Wolken" },
                { location: "München", temp: 12, description: "Starker Regen" },
                { location: "Hamburg", temp: 15, description: "Stark bewölkt mit Wind" },
                { location: "Berlin", temp: 8, description: "Leichter Regen" },
                { location: "Köln", temp: 22, description: "Klarer Himmel" }
            ];
            return weathers[Math.floor(Math.random() * weathers.length)];
        }
        function getLocationAndWeather() { 
            const defaultWeather = { location: "Leutkirch im Allgäu", temp: 14, description: "Leicht bewölkt" };
            if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(async (p) => displayWeather(await fetchWeather(p.coords.latitude, p.coords.longitude)), () => displayWeather(defaultWeather)); } 
            else { displayWeather(defaultWeather); }
        }

        // --- EVENT HANDLERS & FIRESTORE LOGIC ---
        async function handleAddTask() {
            const taskTitle = newTaskInput.value.trim();
            if (!taskTitle) return;

            const assigneeId = newTaskAssignee.value === 'null' ? null : newTaskAssignee.value;
            
            const newTask = {
                title: taskTitle,
                isDone: false,
                priority: newTaskPriority.value,
                recurrence: newTaskRecurrence.value,
                assignedTo: assigneeId,
                completedAt: null,
                dueDate: newTaskDueDate.value || null,
                createdBy: currentUser 
            };
            
            await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), newTask);
            
            if (assigneeId && assigneeId !== currentUser) {
                const sender = familyMembers.find(m => m.id === currentUser);
                if (sender) {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/notifications`), {
                        recipientId: assigneeId,
                        senderName: sender.name,
                        taskTitle: taskTitle,
                        isRead: false,
                        createdAt: new Date().toISOString()
                    });
                }
            }
            
            newTaskInput.value = '';
            newTaskRecurrence.value = 'none';
            newTaskPriority.value = 'medium';
            newTaskAssignee.value = currentUser || 'null';
            newTaskDueDate.value = '';
        }
        
        async function handleAddNote() {
            const title = newNoteTitle.value.trim();
            const content = newNoteContent.value.trim();
            const type = newNoteType.value;
            if (!title && !content) return;
            
            const assigneeId = newNoteAssignee.value === 'null' ? null : newNoteAssignee.value;

            let finalContent = content;
            if (type === 'checklist') {
                finalContent = content.split('\n').filter(line => line.trim() !== '').map(line => ({ text: line, done: false }));
            }

            const newNote = {
                title: title || 'Ohne Titel',
                content: finalContent,
                type: type,
                assignedTo: assigneeId,
                isPinned: false
            };

            await addDoc(collection(db, `artifacts/${appId}/public/data/notes`), newNote);

            newNoteTitle.value = '';
            newNoteContent.value = '';
            newNoteAssignee.value = currentUser || 'null';
            newNoteType.value = 'text';
        }

        async function updateTaskStatus(taskId, isDone) {
            const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            await updateDoc(taskRef, {
                isDone: isDone,
                completedAt: isDone ? new Date().toISOString() : null
            });
        }
        
        async function updateNoteChecklistItem(noteId, itemIndex, isDone) {
            const noteRef = doc(db, `artifacts/${appId}/public/data/notes`, noteId);
            const note = notes.find(n => n.id === noteId);
            if (!note || !note.content[itemIndex]) return;
            
            const updatedContent = [...note.content];
            updatedContent[itemIndex].done = isDone;

            await updateDoc(noteRef, { content: updatedContent });
        }
        
        async function toggleNotePin(noteId) {
             const noteRef = doc(db, `artifacts/${appId}/public/data/notes`, noteId);
             const note = notes.find(n => n.id === noteId);
             if (note) {
                 await updateDoc(noteRef, { isPinned: !note.isPinned });
             }
        }
        
        async function generateRecipe(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note || note.type !== 'checklist') return;

            const ingredients = note.content.map(item => item.text);
            if (ingredients.length === 0) return;
            
            const recipeText = await callGeminiForRecipe(ingredients);
            
            if (recipeText) {
                const lines = recipeText.split('\n');
                const newTitle = lines[0].replace(/#/g, '').trim();
                const newContent = lines.slice(1).join('\n').trim();
                
                const noteRef = doc(db, `artifacts/${appId}/public/data/notes`, noteId);
                await updateDoc(noteRef, {
                    title: newTitle,
                    content: newContent,
                    type: 'text'
                });
            }
        }

        async function dismissNotification(notificationId) {
            const notificationRef = doc(db, `artifacts/${appId}/public/data/notifications`, notificationId);
            await updateDoc(notificationRef, { isRead: true });
        }

        function addTaskActionListeners() {
            document.querySelectorAll('#task-list input[type="checkbox"], #completed-task-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const taskId = event.target.dataset.taskId;
                    updateTaskStatus(taskId, event.target.checked);
                });
            });
            document.querySelectorAll('#task-list .breakdown-btn').forEach(button => {
                button.addEventListener('click', async (event) => { /* ... Breakdowm logic can remain local for now ... */ });
            });
        }
        
        function addNoteActionListeners() {
            document.querySelectorAll('#notes-grid input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    const noteId = event.target.dataset.noteId;
                    const itemIndex = parseInt(event.target.dataset.itemIndex);
                    updateNoteChecklistItem(noteId, itemIndex, event.target.checked);
                });
            });
             document.querySelectorAll('.pin-note-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const noteId = event.currentTarget.dataset.noteId;
                    toggleNotePin(noteId);
                });
            });
            document.querySelectorAll('.recipe-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const buttonEl = event.currentTarget;
                    const noteId = buttonEl.dataset.noteId;
                    buttonEl.disabled = true;
                    buttonEl.innerHTML = `<svg class="animate-spin h-4 w-4 text-blue-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                    generateRecipe(noteId).finally(() => {
                        // The UI will re-render via onSnapshot, no need to manually reset the button
                    });
                });
            });
        }
        
        function addNotificationActionListeners() {
            document.querySelectorAll('.dismiss-notification-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const notificationId = e.currentTarget.dataset.notificationId;
                    dismissNotification(notificationId);
                });
            });
        }
        
        async function handleSaveAllSettings() { 
            const memberDivs = document.querySelectorAll('#settings-member-list > div');
            const memberIdsOnScreen = Array.from(memberDivs).map(div => div.querySelector('input').dataset.memberId);
            
            // Delete members who were removed from UI
            for(const member of familyMembers) {
                if (!memberIdsOnScreen.includes(member.id)) {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/familyMembers`, member.id));
                }
            }

            // Update or add members
            for(const div of memberDivs) {
                const nameInput = div.querySelector('input[placeholder="Name"]');
                const roleInput = div.querySelector('input[placeholder="Rolle (z.B. Sohn)"]');
                const memberId = nameInput.dataset.memberId;
                const memberData = {
                    name: nameInput.value.trim(),
                    role: roleInput.value.trim()
                };
                if (memberId.startsWith('new-')) { // This is a new member
                    await addDoc(collection(db, `artifacts/${appId}/public/data/familyMembers`), memberData);
                } else { // This is an existing member
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/familyMembers`, memberId), memberData);
                }
            }
            closeSettingsModal();
        }
        
        function handleAddMember() { 
            const newId = `new-${Date.now()}`;
            const memberSettingItem = `<div class="flex items-center gap-4 group"><input type="text" value="" data-member-id="${newId}" placeholder="Name" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-slate-700 dark:border-slate-600"><input type="text" value="" data-member-id="${newId}" placeholder="Rolle (z.B. Sohn)" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-slate-700 dark:border-slate-600"><button data-member-id="${newId}" class="remove-member-btn p-2 text-slate-400 hover:text-red-500 hover:bg-red-100 rounded-full transition dark:hover:bg-red-900/50 dark:hover:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></div>`;
            settingsMemberListContainer.insertAdjacentHTML('beforeend', memberSettingItem);
            settingsMemberListContainer.querySelector(`button[data-member-id="${newId}"]`).addEventListener('click', (e) => {
                e.currentTarget.closest('.group').remove();
            });
        }

        function openSettingsModal() { renderSettings(); settingsModal.classList.remove('hidden'); settingsModal.classList.add('flex'); }
        function closeSettingsModal() { settingsModal.classList.add('hidden'); settingsModal.classList.remove('flex'); }
        
        function showPage(pageId) {
            pages.forEach(page => {
                page.style.display = page.id === pageId ? 'block' : 'none';
            });
            navButtons.forEach(btn => {
                if (btn.dataset.page === pageId) {
                    btn.classList.add('nav-btn-active');
                } else {
                    btn.classList.remove('nav-btn-active');
                }
            });
        }

        // --- GLOBAL EVENT LISTENERS ---
        userSelection.addEventListener('change', (event) => {
            const selectedUserId = event.target.value;
            if (selectedUserId && selectedUserId !== 'null') {
                currentUser = selectedUserId;
                nav.style.display = 'flex';
                showPage('dashboard-page');
                renderAllContent();
            } else {
                currentUser = null;
                nav.style.display = 'none';
                pages.forEach(page => {
                    page.style.display = 'none';
                });
            }
        });

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                if (currentUser) {
                    showPage(btn.dataset.page);
                }
            });
        });

        toggleCompletedTasksBtn.addEventListener('click', () => {
            completedTaskListWrapper.classList.toggle('hidden');
            completedChevron.classList.toggle('rotate-180');
        });

        darkModeToggle.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        addTaskBtn.addEventListener('click', handleAddTask);
        addNoteBtn.addEventListener('click', handleAddNote);
        openSettingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        setupGoToSettingsBtn.addEventListener('click', openSettingsModal);
        addMemberBtn.addEventListener('click', handleAddMember);
        saveAllSettingsBtn.addEventListener('click', handleSaveAllSettings);
        settingsModal.querySelector('.modal-backdrop').addEventListener('click', closeSettingsModal);

        // --- FIREBASE INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        async function initializeFirebase() {
            try {
                const app = initializeFirebaseApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase Auth successful. User:", auth.currentUser.uid);

                // Setup listeners
                const membersCol = collection(db, `artifacts/${appId}/public/data/familyMembers`);
                onSnapshot(membersCol, (snapshot) => {
                    familyMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (snapshot.empty) {
                        currentUser = null;
                        userSelection.style.display = 'none';
                        userSelectionLabel.style.display = 'none';
                        nav.style.display = 'none';
                        pages.forEach(p => p.style.display = 'none');
                        setupMessage.style.display = 'block';
                    } else {
                        const previousUser = currentUser;
                        setupMessage.style.display = 'none';
                        userSelection.style.display = 'block';
                        userSelectionLabel.style.display = 'block';
                        nav.style.display = 'block';

                        populateUserSelection();
                        const currentUserStillExists = familyMembers.some(m => m.id === previousUser);
                        if(previousUser && currentUserStillExists) {
                            userSelection.value = previousUser;
                        } else {
                             userSelection.value = 'null';
                             userSelection.dispatchEvent(new Event('change'));
                        }
                    }
                    populateAllAssigneeDropdowns();
                    renderAllContent();
                });

                const tasksCol = collection(db, `artifacts/${appId}/public/data/tasks`);
                onSnapshot(tasksCol, (snapshot) => {
                    tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAllContent();
                });
                
                const notesCol = collection(db, `artifacts/${appId}/public/data/notes`);
                 onSnapshot(notesCol, (snapshot) => {
                    notes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAllContent();
                });

                const notificationsCol = collection(db, `artifacts/${appId}/public/data/notifications`);
                 onSnapshot(notificationsCol, (snapshot) => {
                    notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderNotifications();
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }

        // --- APP INITIALIZATION ---
        function startApp() {
            initializeFirebase();
            initializeTheme();
            updateTime();
            setInterval(updateTime, 1000);
            calendarWeekEl.textContent = `KW ${getCalendarWeek()}`;
            getLocationAndWeather();
            pages.forEach(page => page.style.display = 'none');
            nav.style.display = 'none';
        }

        startApp();
    </script>
</body>
</html>

